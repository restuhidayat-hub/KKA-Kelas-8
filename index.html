<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pertualangan Nested Loop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes celebrate {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(-10deg) scale(1.1); }
      75% { transform: rotate(10deg) scale(1.1); }
      100% { transform: rotate(0deg) scale(1); }
    }
    
    .block-dragging {
      opacity: 0.5;
    }
    
    .drop-zone-active {
      background-color: rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
    }
    
    .celebrating {
      animation: celebrate 0.5s ease-in-out;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto"></div>
  <script>
    const config = {
      background_color: "#1e293b",
      surface_color: "#334155",
      text_color: "#f1f5f9",
      primary_action_color: "#10b981",
      secondary_action_color: "#3b82f6",
      font_family: "Arial",
      font_size: 16,
      game_title: "Pertualangan Nested Loop 1",
      instruction_text: "Susun blok perulangan untuk mencapai target!"
    };
    let gameState = {
      currentLevel: 1,
      score: 0,
      draggedBlock: null,
      playerName: '',
      startTime: null,
      gameStarted: false
    };

    const levels = [
      {
        level: 1,
        title: "Level 1: Baris Sederhana",
        description: "Buat 1 baris dengan 5 bintang",
        target: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ",
        variables: "i = variabel penghitung untuk mengulang cetak bintang",
        requiredBlocks: [
          { type: "for", label: "FOR i = 1 TO 5", iterations: 5, order: 0, isCorrect: true }
        ],
        distractorBlocks: [
          { type: "for", label: "FOR i = 1 TO 3", iterations: 3, order: 0, isCorrect: false },
          { type: "for", label: "FOR i = 1 TO 7", iterations: 7, order: 0, isCorrect: false },
          { type: "for", label: "FOR j = 1 TO 4", iterations: 4, order: 0, isCorrect: false }
        ],
        hint: "Gunakan 1 loop FOR untuk mengulang 5 kali"
      },
      {
        level: 2,
        title: "Level 2: Dua Baris",
        description: "Buat 2 baris, masing-masing 4 bintang",
        target: "‚òÖ‚òÖ‚òÖ‚òÖ\n‚òÖ‚òÖ‚òÖ‚òÖ",
        variables: "i = variabel untuk baris\nj = variabel untuk bintang dalam 1 baris",
        requiredBlocks: [
          { type: "for", label: "FOR i = 1 TO 2", iterations: 2, order: 0, isCorrect: true },
          { type: "for", label: "FOR j = 1 TO 4", iterations: 4, order: 1, isCorrect: true }
        ],
        distractorBlocks: [
          { type: "for", label: "FOR i = 1 TO 3", iterations: 3, order: 0, isCorrect: false },
          { type: "for", label: "FOR j = 1 TO 2", iterations: 2, order: 1, isCorrect: false },
          { type: "for", label: "FOR k = 1 TO 5", iterations: 5, order: 1, isCorrect: false }
        ],
        hint: "Loop luar (i) untuk baris, loop dalam (j) untuk bintang per baris"
      },
      {
        level: 3,
        title: "Level 3: Kotak 3x3",
        description: "Buat kotak 3 baris √ó 3 kolom",
        target: "‚òÖ‚òÖ‚òÖ\n‚òÖ‚òÖ‚òÖ\n‚òÖ‚òÖ‚òÖ",
        variables: "i = variabel untuk baris\nj = variabel untuk kolom/bintang",
        requiredBlocks: [
          { type: "for", label: "FOR i = 1 TO 3", iterations: 3, order: 0, isCorrect: true },
          { type: "for", label: "FOR j = 1 TO 3", iterations: 3, order: 1, isCorrect: true }
        ],
        distractorBlocks: [
          { type: "for", label: "FOR i = 1 TO 4", iterations: 4, order: 0, isCorrect: false },
          { type: "for", label: "FOR j = 1 TO 2", iterations: 2, order: 1, isCorrect: false },
          { type: "for", label: "FOR k = 1 TO 3", iterations: 3, order: 1, isCorrect: false }
        ],
        hint: "Loop luar (i) untuk 3 baris, loop dalam (j) untuk 3 bintang"
      },
      {
        level: 4,
        title: "Level 4: Tangga Naik",
        description: "Buat pola tangga naik",
        target: "‚òÖ\n‚òÖ‚òÖ\n‚òÖ‚òÖ‚òÖ\n‚òÖ‚òÖ‚òÖ‚òÖ",
        variables: "i = variabel untuk baris\nj = variabel untuk bintang, maksimalnya sesuai nilai i",
        requiredBlocks: [
          { type: "for", label: "FOR i = 1 TO 4", iterations: 4, order: 0, isCorrect: true },
          { type: "for", label: "FOR j = 1 TO i", iterations: "variable", order: 1, isCorrect: true }
        ],
        distractorBlocks: [
          { type: "for", label: "FOR i = 1 TO 5", iterations: 5, order: 0, isCorrect: false },
          { type: "for", label: "FOR j = 1 TO 4", iterations: 4, order: 1, isCorrect: false },
          { type: "for", label: "FOR j = 1 TO 3", iterations: 3, order: 1, isCorrect: false }
        ],
        hint: "Loop dalam (j) bergantung pada nilai i dari loop luar"
      },
      {
        level: 5,
        title: "Level 5: Piramida",
        description: "Buat piramida sempurna 4 tingkat",
        target: "   ‚òÖ\n  ‚òÖ‚òÖ‚òÖ\n ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ\n‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ",
        variables: "i = variabel untuk baris\ns = variabel untuk spasi sebelum bintang\nj = variabel untuk bintang",
        requiredBlocks: [
          { type: "for", label: "FOR i = 1 TO 4", iterations: 4, order: 0, isCorrect: true },
          { type: "for", label: "FOR s = 1 TO (4-i)", iterations: "variable", order: 1, isCorrect: true },
          { type: "for", label: "FOR j = 1 TO (2*i-1)", iterations: "variable", order: 2, isCorrect: true }
        ],
        distractorBlocks: [
          { type: "for", label: "FOR i = 1 TO 5", iterations: 5, order: 0, isCorrect: false },
          { type: "for", label: "FOR s = 1 TO i", iterations: "variable", order: 1, isCorrect: false },
          { type: "for", label: "FOR j = 1 TO i", iterations: "variable", order: 2, isCorrect: false }
        ],
        hint: "Urutan: loop baris (i), lalu spasi (s), lalu bintang (j)"
      }
    ];

    function initApp() {
      loadLeaderboard();
      renderApp();
    }

    function loadLeaderboard() {
      const stored = localStorage.getItem('nestedLoopLeaderboard');
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    function saveToLeaderboardStorage(record) {
      const leaderboard = loadLeaderboard();
      leaderboard.push(record);
      localStorage.setItem('nestedLoopLeaderboard', JSON.stringify(leaderboard));
      renderLeaderboard(leaderboard);
    }

    function renderApp() {
      if (!gameState.gameStarted) {
        renderNameScreen();
        return;
      }
      
      const app = document.getElementById('app');
      const baseSize = config.font_size;
      const customFont = config.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;
      
      const backgroundColor = config.background_color;
      const surfaceColor = config.surface_color;
      const textColor = config.text_color;
      const primaryColor = config.primary_action_color;
      const secondaryColor = config.secondary_action_color;
      const gameTitle = config.game_title;
      const instructionText = config.instruction_text;

      app.innerHTML = `
        <div style="background: ${backgroundColor}; min-height: 100%; padding: 24px; font-family: ${fontFamily};">
          <!-- Header -->
          <header style="text-align: center; margin-bottom: 32px;">
            <h1 style="font-size: ${baseSize * 2}px; font-weight: bold; color: ${textColor}; margin-bottom: 8px;">
              ${gameTitle}
            </h1>
            <p style="font-size: ${baseSize * 1.1}px; color: ${textColor}; opacity: 0.9;">
              ${instructionText}
            </p>
            <div style="margin-top: 16px; display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;">
              <div style="background: ${surfaceColor}; padding: 12px 24px; border-radius: 8px;">
                <span style="color: ${textColor}; font-size: ${baseSize}px;">Pemain: </span>
                <span style="color: ${primaryColor}; font-weight: bold; font-size: ${baseSize * 1.2}px;">${gameState.playerName}</span>
              </div>
              <div style="background: ${surfaceColor}; padding: 12px 24px; border-radius: 8px;">
                <span style="color: ${textColor}; font-size: ${baseSize}px;">Level: </span>
                <span id="current-level" style="color: ${primaryColor}; font-weight: bold; font-size: ${baseSize * 1.2}px;">${gameState.currentLevel}</span>
              </div>
              <div style="background: ${surfaceColor}; padding: 12px 24px; border-radius: 8px;">
                <span style="color: ${textColor}; font-size: ${baseSize}px;">Skor: </span>
                <span id="score-display" style="color: ${primaryColor}; font-weight: bold; font-size: ${baseSize * 1.2}px;">${gameState.score}</span>
              </div>
              <div style="background: ${surfaceColor}; padding: 12px 24px; border-radius: 8px;">
                <span style="color: ${textColor}; font-size: ${baseSize}px;">Waktu: </span>
                <span id="time-display" style="color: ${primaryColor}; font-weight: bold; font-size: ${baseSize * 1.2}px;">00:00</span>
              </div>
            </div>
          </header>

          <main style="max-width: 1200px; margin: 0 auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
              <!-- Level Info -->
              <div style="background: ${surfaceColor}; padding: 24px; border-radius: 12px; border: 2px solid ${primaryColor};">
                <h2 id="level-title" style="font-size: ${baseSize * 1.5}px; font-weight: bold; color: ${primaryColor}; margin-bottom: 12px;">
                  ${levels[gameState.currentLevel - 1].title}
                </h2>
                <p id="level-description" style="color: ${textColor}; font-size: ${baseSize}px; margin-bottom: 16px;">
                  ${levels[gameState.currentLevel - 1].description}
                </p>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid ${primaryColor}; margin-bottom: 12px;">
                  <label style="color: ${textColor}; font-size: ${baseSize * 0.9}px; display: block; margin-bottom: 6px; font-weight: bold;">üìù Keterangan Variabel:</label>
                  <pre id="variables-info" style="color: ${textColor}; font-size: ${baseSize * 0.85}px; white-space: pre-wrap; line-height: 1.6;">${levels[gameState.currentLevel - 1].variables}</pre>
                </div>
                <div style="background: ${backgroundColor}; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                  <label style="color: ${textColor}; font-size: ${baseSize * 0.9}px; display: block; margin-bottom: 8px;">Target Output:</label>
                  <pre id="target-output" style="color: ${primaryColor}; font-size: ${baseSize * 1.2}px; font-family: monospace; white-space: pre;">${levels[gameState.currentLevel - 1].target}</pre>
                </div>
                <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid ${secondaryColor};">
                  <p id="hint-text" style="color: ${textColor}; font-size: ${baseSize * 0.85}px;">
                    üí° ${levels[gameState.currentLevel - 1].hint}
                  </p>
                </div>
              </div>

              <!-- Blok Tersedia -->
              <div style="background: ${surfaceColor}; padding: 24px; border-radius: 12px;">
                <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px;">
                  üì¶ Blok Tersedia
                </h3>
                <p style="color: ${textColor}; font-size: ${baseSize * 0.85}px; margin-bottom: 12px; opacity: 0.9;">
                  ‚ö†Ô∏è Susun blok sesuai urutan: loop luar di atas, loop dalam di bawah! Pilih blok yang tepat.
                </p>
                <div id="available-blocks" style="display: flex; flex-direction: column; gap: 12px;">
                  <!-- Blocks will be rendered here -->
                </div>
              </div>
            </div>

            <!-- Area Penyusunan -->
            <div style="background: ${surfaceColor}; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
              <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px;">
                üîß Area Penyusunan Kode
              </h3>
              <div id="code-area" style="background: ${backgroundColor}; padding: 20px; border-radius: 8px; min-height: 200px; border: 2px dashed ${primaryColor};">
                <p style="color: ${textColor}; opacity: 0.5; text-align: center; font-size: ${baseSize}px;">
                  Tarik blok ke sini untuk menyusun kode
                </p>
              </div>
            </div>

            <!-- Output & Kontrol -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div style="background: ${surfaceColor}; padding: 24px; border-radius: 12px;">
                <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px;">
                  üìä Output Program
                </h3>
                <div style="background: ${backgroundColor}; padding: 16px; border-radius: 8px; min-height: 150px;">
                  <pre id="program-output" style="color: ${textColor}; font-size: ${baseSize * 1.1}px; font-family: monospace; white-space: pre;">Belum ada output</pre>
                </div>
                <div id="feedback-message" style="margin-top: 12px; padding: 12px; border-radius: 8px; display: none;">
                </div>
              </div>

              <div style="background: ${surfaceColor}; padding: 24px; border-radius: 12px;">
                <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px;">
                  üéÆ Kontrol
                </h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                  <button id="run-btn" style="background: ${primaryColor}; color: white; padding: 16px; border-radius: 8px; border: none; font-size: ${baseSize * 1.1}px; font-weight: bold; cursor: pointer; font-family: ${fontFamily};">
                    ‚ñ∂Ô∏è Jalankan Kode
                  </button>
                  <button id="clear-btn" style="background: ${secondaryColor}; color: white; padding: 16px; border-radius: 8px; border: none; font-size: ${baseSize * 1.1}px; font-weight: bold; cursor: pointer; font-family: ${fontFamily};">
                    üîÑ Reset Area
                  </button>
                  <button id="next-level-btn" style="background: ${primaryColor}; color: white; padding: 16px; border-radius: 8px; border: none; font-size: ${baseSize * 1.1}px; font-weight: bold; cursor: pointer; display: none; font-family: ${fontFamily};">
                    ‚û°Ô∏è Level Selanjutnya
                  </button>
                </div>
              </div>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboard-section" style="background: ${surfaceColor}; padding: 24px; border-radius: 12px; margin-top: 24px;">
              <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px;">
                üèÜ Leaderboard - Tercepat Menyelesaikan Semua Level
              </h3>
              <div id="progress-history" style="color: ${textColor}; font-size: ${baseSize * 0.9}px;">
                Belum ada data
              </div>
            </div>
          </main>
        </div>
      `;

      renderBlocks();
      attachEventListeners();
    }

    function renderBlocks() {
      const container = document.getElementById('available-blocks');
      const level = levels[gameState.currentLevel - 1];
      const textColor = config.text_color;
      const secondaryColor = config.secondary_action_color;
      const primaryColor = config.primary_action_color;
      const baseSize = config.font_size;
      const customFont = config.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;
      
      // Gabungkan blok yang benar dengan blok pengecoh
      const allBlocks = [...level.requiredBlocks, ...level.distractorBlocks];
      
      // Acak urutan blok agar tidak terlalu mudah
      const shuffledBlocks = allBlocks.sort(() => Math.random() - 0.5);
      
      container.innerHTML = shuffledBlocks.map((block, index) => `
        <div 
          draggable="true" 
          data-block-index="${index}"
          data-block-label="${block.label}"
          data-block-order="${block.order}"
          data-is-correct="${block.isCorrect}"
          class="code-block"
          style="background: ${secondaryColor}; color: white; padding: 16px; border-radius: 8px; cursor: move; user-select: none; font-family: monospace; font-size: ${baseSize}px; font-family: ${fontFamily}; font-weight: bold;"
        >
          ${block.label}
        </div>
      `).join('');

      const blocks = container.querySelectorAll('.code-block');
      blocks.forEach((block, idx) => {
        block.blockData = shuffledBlocks[idx];
        block.addEventListener('dragstart', handleDragStart);
        block.addEventListener('dragend', handleDragEnd);
      });
    }

    function attachEventListeners() {
      const codeArea = document.getElementById('code-area');
      codeArea.addEventListener('dragover', handleDragOver);
      codeArea.addEventListener('drop', handleDrop);
      codeArea.addEventListener('dragleave', handleDragLeave);

      document.getElementById('run-btn').addEventListener('click', runCode);
      document.getElementById('clear-btn').addEventListener('click', clearCodeArea);
      document.getElementById('next-level-btn').addEventListener('click', nextLevel);
    }

    function handleDragStart(e) {
      gameState.draggedBlock = e.target.blockData;
      e.target.classList.add('block-dragging');
      e.dataTransfer.effectAllowed = 'copy';
    }

    function handleDragEnd(e) {
      e.target.classList.remove('block-dragging');
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      if (e.currentTarget.id === 'code-area') {
        e.currentTarget.classList.add('drop-zone-active');
      }
    }

    function handleDragLeave(e) {
      if (e.currentTarget.id === 'code-area') {
        e.currentTarget.classList.remove('drop-zone-active');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      const codeArea = document.getElementById('code-area');
      codeArea.classList.remove('drop-zone-active');
      
      if (!gameState.draggedBlock) return;

      const textColor = config.text_color;
      const secondaryColor = config.secondary_action_color;
      const primaryColor = config.primary_action_color;
      const surfaceColor = config.surface_color;
      const baseSize = config.font_size;
      const customFont = config.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;

      if (codeArea.querySelector('p')) {
        codeArea.innerHTML = '';
      }

      const placedCount = codeArea.querySelectorAll('.placed-block').length;

      const blockDiv = document.createElement('div');
      blockDiv.className = 'placed-block';
      blockDiv.blockData = gameState.draggedBlock;
      blockDiv.style.cssText = `background: ${secondaryColor}; color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-family: monospace; font-size: ${baseSize * 0.9}px; font-family: ${fontFamily}; margin-left: ${placedCount * 20}px;`;
      blockDiv.innerHTML = `
        <span>${gameState.draggedBlock.label}</span>
        <button class="remove-block" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: ${baseSize * 0.85}px; font-family: ${fontFamily};">‚úï</button>
      `;
      
      blockDiv.querySelector('.remove-block').addEventListener('click', function() {
        blockDiv.remove();
        if (!document.getElementById('code-area').querySelector('.placed-block')) {
          document.getElementById('code-area').innerHTML = `<p style="color: ${textColor}; opacity: 0.5; text-align: center; font-size: ${baseSize}px;">Tarik blok ke sini untuk menyusun kode</p>`;
        }
      });

      codeArea.appendChild(blockDiv);
      gameState.draggedBlock = null;
    }

    function clearCodeArea() {
      const codeArea = document.getElementById('code-area');
      const textColor = config.text_color;
      const baseSize = config.font_size;
      codeArea.innerHTML = `<p style="color: ${textColor}; opacity: 0.5; text-align: center; font-size: ${baseSize}px;">Tarik blok ke sini untuk menyusun kode</p>`;
      document.getElementById('program-output').textContent = 'Belum ada output';
      document.getElementById('feedback-message').style.display = 'none';
      document.getElementById('next-level-btn').style.display = 'none';
    }

    function runCode() {
      const placedBlocks = document.querySelectorAll('.placed-block');
      const level = levels[gameState.currentLevel - 1];
      
      if (placedBlocks.length === 0) {
        showFeedback('Belum ada blok yang disusun! Tarik blok ke area kode.', false);
        return;
      }

      if (placedBlocks.length !== level.requiredBlocks.length) {
        showFeedback(`Jumlah blok belum tepat! Butuh ${level.requiredBlocks.length} blok.`, false);
        return;
      }

      // Ekstrak data blok yang dipasang user
      const userBlocks = [];
      placedBlocks.forEach(block => {
        userBlocks.push(block.blockData);
      });

      // Generate output dari blok yang dipasang user
      const output = generateOutputFromBlocks(userBlocks, level);
      document.getElementById('program-output').textContent = output;

      // Validasi urutan dan blok yang benar
      let isValid = true;
      let errorMessage = '';
      
      placedBlocks.forEach((block, index) => {
        const blockData = block.blockData;
        const expectedBlock = level.requiredBlocks[index];
        
        // Cek apakah blok yang dipilih adalah blok yang benar
        if (!blockData.isCorrect) {
          isValid = false;
          errorMessage = '‚ùå Ada blok yang salah! Pilih blok dengan angka yang tepat.';
          return;
        }
        
        // Cek urutan blok
        if (blockData.label.trim() !== expectedBlock.label.trim() || blockData.order !== expectedBlock.order) {
          isValid = false;
          errorMessage = '‚ùå Urutan blok salah! Loop luar harus di atas, loop dalam di bawahnya.';
          return;
        }
      });

      if (!isValid) {
        showFeedback(errorMessage, false);
        document.getElementById('next-level-btn').style.display = 'none';
        return;
      }

      if (output.trim() === level.target.trim()) {
        gameState.score += level.level * 100;
        document.getElementById('score-display').textContent = gameState.score;
        showFeedback('üéâ Benar! Kode kamu berhasil! Level selesai!', true);
        document.getElementById('next-level-btn').style.display = 'block';
        
        // Jika level terakhir selesai, simpan ke leaderboard
        if (gameState.currentLevel === levels.length) {
          saveToLeaderboard();
        }
      } else {
        showFeedback('‚ùå Output belum sesuai target. Coba periksa lagi!', false);
        document.getElementById('next-level-btn').style.display = 'none';
      }
    }

    function generateOutput(level) {
      let output = '';
      
      if (level.level === 1) {
        for (let i = 0; i < 5; i++) {
          output += '‚òÖ';
        }
      } else if (level.level === 2) {
        for (let i = 0; i < 2; i++) {
          for (let j = 0; j < 4; j++) {
            output += '‚òÖ';
          }
          if (i < 1) output += '\n';
        }
      } else if (level.level === 3) {
        for (let i = 0; i < 3; i++) {
          for (let j = 0; j < 3; j++) {
            output += '‚òÖ';
          }
          if (i < 2) output += '\n';
        }
      } else if (level.level === 4) {
        for (let i = 1; i <= 4; i++) {
          for (let j = 1; j <= i; j++) {
            output += 'ÔøΩÔøΩÔøΩ';
          }
          if (i < 4) output += '\n';
        }
      } else if (level.level === 5) {
        for (let i = 1; i <= 4; i++) {
          for (let s = 1; s <= (4 - i); s++) {
            output += ' ';
          }
          for (let j = 1; j <= (2 * i - 1); j++) {
            output += '‚òÖ';
          }
          if (i < 4) output += '\n';
        }
      }
      
      return output;
    }

    function generateOutputFromBlocks(userBlocks, level) {
      let output = '';
      
      // Ekstrak nilai iterasi dari label blok
      function extractIterations(label) {
        // Untuk blok seperti "FOR i = 1 TO 5"
        const match = label.match(/TO (\d+)/);
        if (match) {
          return parseInt(match[1]);
        }
        
        // Untuk blok seperti "FOR j = 1 TO i" atau "FOR j = 1 TO (2*i-1)"
        if (label.includes('TO i')) {
          return 'i';
        }
        if (label.includes('TO (4-i)')) {
          return '4-i';
        }
        if (label.includes('TO (2*i-1)')) {
          return '2*i-1';
        }
        
        return 1;
      }
      
      if (level.level === 1) {
        const iterations = extractIterations(userBlocks[0].label);
        for (let i = 0; i < iterations; i++) {
          output += '‚òÖ';
        }
      } else if (level.level === 2) {
        const outerIterations = extractIterations(userBlocks[0].label);
        const innerIterations = extractIterations(userBlocks[1].label);
        for (let i = 0; i < outerIterations; i++) {
          for (let j = 0; j < innerIterations; j++) {
            output += '‚òÖ';
          }
          if (i < outerIterations - 1) output += '\n';
        }
      } else if (level.level === 3) {
        const outerIterations = extractIterations(userBlocks[0].label);
        const innerIterations = extractIterations(userBlocks[1].label);
        for (let i = 0; i < outerIterations; i++) {
          for (let j = 0; j < innerIterations; j++) {
            output += '‚òÖ';
          }
          if (i < outerIterations - 1) output += '\n';
        }
      } else if (level.level === 4) {
        const outerIterations = extractIterations(userBlocks[0].label);
        const innerType = extractIterations(userBlocks[1].label);
        
        for (let i = 1; i <= outerIterations; i++) {
          let innerCount = innerType === 'i' ? i : (typeof innerType === 'number' ? innerType : i);
          for (let j = 1; j <= innerCount; j++) {
            output += '‚òÖ';
          }
          if (i < outerIterations) output += '\n';
        }
      } else if (level.level === 5) {
        const outerIterations = extractIterations(userBlocks[0].label);
        const spaceType = extractIterations(userBlocks[1].label);
        const starType = extractIterations(userBlocks[2].label);
        
        for (let i = 1; i <= outerIterations; i++) {
          // Spasi
          let spaceCount = spaceType === '4-i' ? (4 - i) : (typeof spaceType === 'number' ? spaceType : 0);
          for (let s = 1; s <= spaceCount; s++) {
            output += ' ';
          }
          
          // Bintang
          let starCount = starType === '2*i-1' ? (2 * i - 1) : (starType === 'i' ? i : (typeof starType === 'number' ? starType : 1));
          for (let j = 1; j <= starCount; j++) {
            output += '‚òÖ';
          }
          
          if (i < outerIterations) output += '\n';
        }
      }
      
      return output;
    }

    function showFeedback(message, isSuccess) {
      const feedback = document.getElementById('feedback-message');
      const primaryColor = config.primary_action_color;
      const baseSize = config.font_size;
      const customFont = config.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;
      
      feedback.style.display = 'block';
      feedback.style.background = isSuccess ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
      feedback.style.borderLeft = `4px solid ${isSuccess ? primaryColor : '#ef4444'}`;
      feedback.style.color = config.text_color;
      feedback.style.fontSize = `${baseSize}px`;
      feedback.style.fontFamily = fontFamily;
      feedback.textContent = message;
      
      if (isSuccess) {
        feedback.classList.add('celebrating');
        setTimeout(() => feedback.classList.remove('celebrating'), 500);
      }
    }

    function updateTimer() {
      if (!gameState.startTime) return;
      
      const elapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      const timeDisplay = document.getElementById('time-display');
      if (timeDisplay) {
        timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }
    }

    function saveToLeaderboard() {
      const duration = Math.floor((Date.now() - gameState.startTime) / 1000);
      
      const record = {
        player_name: gameState.playerName,
        total_score: gameState.score,
        duration_seconds: duration,
        completed_at: new Date().toISOString(),
        levels_completed: levels.length
      };

      saveToLeaderboardStorage(record);
    }

    function renderLeaderboard(data = null) {
      const container = document.getElementById('progress-history');
      if (!container) return;
      
      const leaderboardData = data || loadLeaderboard();
      const textColor = config.text_color;
      const primaryColor = config.primary_action_color;
      const backgroundColor = config.background_color;
      const baseSize = config.font_size;
      const customFont = config.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;
      
      if (!leaderboardData || leaderboardData.length === 0) {
        container.innerHTML = `<p style="color: ${textColor}; opacity: 0.7; font-size: ${baseSize * 0.9}px; font-family: ${fontFamily};">Belum ada data. Selesaikan semua level untuk masuk leaderboard!</p>`;
        return;
      }

      // Filter hanya yang menyelesaikan semua level
      const completedGames = leaderboardData.filter(record => record.levels_completed === levels.length);
      
      if (completedGames.length === 0) {
        container.innerHTML = `<p style="color: ${textColor}; opacity: 0.7; font-size: ${baseSize * 0.9}px; font-family: ${fontFamily};">Belum ada yang menyelesaikan semua level. Jadilah yang pertama!</p>`;
        return;
      }

      // Urutkan berdasarkan durasi tercepat
      const sortedData = [...completedGames].sort((a, b) => a.duration_seconds - b.duration_seconds);

      const medals = ['ü•á', 'ü•à', 'ü•â'];
      
      container.innerHTML = sortedData.slice(0, 10).map((record, index) => {
        const minutes = Math.floor(record.duration_seconds / 60);
        const seconds = record.duration_seconds % 60;
        const timeStr = `${minutes}m ${seconds}s`;
        const medal = medals[index] || `${index + 1}.`;
        
        return `
          <div style="background: ${backgroundColor}; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: ${baseSize * 1.3}px;">${medal}</span>
              <div>
                <div style="color: ${primaryColor}; font-weight: bold; font-size: ${baseSize}px; font-family: ${fontFamily};">${record.player_name}</div>
                <div style="color: ${textColor}; opacity: 0.7; font-size: ${baseSize * 0.85}px; font-family: ${fontFamily};">
                  Skor: ${record.total_score}
                </div>
              </div>
            </div>
            <div style="text-align: right;">
              <div style="color: ${primaryColor}; font-weight: bold; font-size: ${baseSize * 1.1}px; font-family: ${fontFamily};">‚è±Ô∏è ${timeStr}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderNameScreen() {
      const app = document.getElementById('app');
      const baseSize = config.font_size;
      const customFont = config.font_family;
      const baseFontStack = 'Arial, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;
      
      const backgroundColor = config.background_color;
      const surfaceColor = config.surface_color;
      const textColor = config.text_color;
      const primaryColor = config.primary_action_color;
      const gameTitle = config.game_title;
      const instructionText = config.instruction_text;

      app.innerHTML = `
        <div style="background: ${backgroundColor}; min-height: 100%; padding: 24px; font-family: ${fontFamily}; display: flex; align-items: center; justify-content: center;">
          <div style="max-width: 600px; width: 100%;">
            <div style="background: ${surfaceColor}; padding: 48px; border-radius: 16px; text-align: center;">
              <h1 style="font-size: ${baseSize * 2.5}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px;">
                ${gameTitle}
              </h1>
              <p style="font-size: ${baseSize * 1.1}px; color: ${textColor}; opacity: 0.9; margin-bottom: 32px;">
                ${instructionText}
              </p>
              
              <div style="margin-bottom: 32px;">
                <label for="player-name-input" style="display: block; color: ${textColor}; font-size: ${baseSize}px; margin-bottom: 12px; font-weight: bold;">
                  Masukkan Nama Kamu:
                </label>
                <input 
                  type="text" 
                  id="player-name-input"
                  placeholder="Nama pemain..."
                  maxlength="20"
                  style="width: 100%; padding: 16px; border-radius: 8px; border: 2px solid ${primaryColor}; font-size: ${baseSize * 1.1}px; font-family: ${fontFamily}; background: ${backgroundColor}; color: ${textColor}; box-sizing: border-box;"
                />
              </div>
              
              <button 
                id="start-game-btn"
                style="background: ${primaryColor}; color: white; padding: 16px 48px; border-radius: 8px; border: none; font-size: ${baseSize * 1.2}px; font-weight: bold; cursor: pointer; font-family: ${fontFamily}; width: 100%;"
              >
                üöÄ Mulai Pertualangan!
              </button>
              
              <div id="name-error" style="color: #ef4444; font-size: ${baseSize * 0.9}px; margin-top: 12px; display: none;"></div>
            </div>
            
            <!-- Leaderboard Preview -->
            <div style="background: ${surfaceColor}; padding: 24px; border-radius: 12px; margin-top: 24px;">
              <h3 style="font-size: ${baseSize * 1.3}px; font-weight: bold; color: ${textColor}; margin-bottom: 16px; text-align: center;">
                üèÜ Leaderboard Tercepat
              </h3>
              <div id="progress-history" style="color: ${textColor}; font-size: ${baseSize * 0.9}px;">
                Memuat data...
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('start-game-btn').addEventListener('click', startGame);
      document.getElementById('player-name-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          startGame();
        }
      });
      
      renderLeaderboard();
    }

    function startGame() {
      const nameInput = document.getElementById('player-name-input');
      const errorDiv = document.getElementById('name-error');
      const name = nameInput.value.trim();
      
      if (name.length < 2) {
        errorDiv.textContent = 'Nama minimal 2 karakter!';
        errorDiv.style.display = 'block';
        return;
      }
      
      gameState.playerName = name;
      gameState.gameStarted = true;
      gameState.startTime = Date.now();
      
      // Mulai timer
      setInterval(updateTimer, 1000);
      
      renderApp();
    }

    function nextLevel() {
      if (gameState.currentLevel < levels.length) {
        gameState.currentLevel++;
        clearCodeArea();
        renderApp();
      } else {
        showFeedback('üéä Selamat! Kamu sudah menyelesaikan semua level! Cek leaderboard di bawah.', true);
        document.getElementById('next-level-btn').style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', initApp);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b7851abd36e243f',t:'MTc2NzMzNjU5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
